<!doctype html><html lang=zh><meta charset=utf-8><meta name=viewport content="width=device-width"><title>安装Opencv4nodejs的坑 | RQ MA</title><meta name=generator content="Hugo Eureka 0.8.0"><link rel=stylesheet href=/css/eureka.min.css><script defer src=/js/eureka.min.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script><link rel=icon type=image/png sizes=32x32 href=/images/icon_hufe282a50f3886d4604387e18d88a80ad_43066_32x32_fill_box_center_2.png><link rel=apple-touch-icon sizes=180x180 href=/images/icon_hufe282a50f3886d4604387e18d88a80ad_43066_180x180_fill_box_center_2.png><meta name=description content="基本信息 太长不看只要正确步骤 走过的路&踩过的坑 基本信息 平台：Win10 安装目的：使用Appium提供的Finding and Interacting with Image Elements功"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/zh/posts/"},{"@type":"ListItem","position":2,"name":"安装Opencv4nodejs的坑","item":"/zh/posts/appium-install-opencv4nodejs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/zh/posts/appium-install-opencv4nodejs/"},"headline":"安装Opencv4nodejs的坑 | RQ MA","datePublished":"2020-11-12T15:46:05+08:00","dateModified":"2020-11-12T15:46:05+08:00","wordCount":3395,"author":{"@type":"Person","name":["mrq"]},"publisher":{"@type":"Person","name":"Example publisher","logo":{"@type":"ImageObject","url":"/images/icon.png"}},"description":"基本信息 太长不看只要正确步骤 走过的路\u0026amp;踩过的坑 基本信息 平台：Win10 安装目的：使用Appium提供的Finding and Interacting with Image Elements功"}</script><meta property="og:title" content="安装Opencv4nodejs的坑 | RQ MA"><meta property="og:type" content="article"><meta property="og:image" content="/images/icon.png"><meta property="og:url" content="/zh/posts/appium-install-opencv4nodejs/"><meta property="og:description" content="基本信息 太长不看只要正确步骤 走过的路&踩过的坑 基本信息 平台：Win10 安装目的：使用Appium提供的Finding and Interacting with Image Elements功"><meta property="og:locale" content="zh"><meta property="og:site_name" content="RQ MA"><meta property="article:published_time" content="2020-11-12T15:46:05+08:00"><meta property="article:modified_time" content="2020-11-12T15:46:05+08:00"><meta property="article:section" content="posts"><meta property="article:tag" content="Appium"><meta property="article:tag" content="opencv4nodejs"><meta property="article:tag" content="Installation"><meta property="og:see_also" content="/zh/posts/appium-jiangnan-script-auto-well/"><meta property="og:see_also" content="/zh/posts/appium-python/"><body class="flex flex-col min-h-screen"><header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm"><div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/zh class="mr-6 text-primary-text text-xl font-bold">RQ MA</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/zh/#about class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About</a>
<a href=/zh/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Posts</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>浅色</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>深色</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>自动</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="flex-grow pt-16"><div class=pl-scrollbar><div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto"><div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12"><div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8"><h1 class="font-bold text-3xl text-primary-text">安装Opencv4nodejs的坑</h1><div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text"><div class="mr-6 my-2"><i class="fas fa-calendar mr-1"></i>
<span>2020-11-12</span></div><div class="mr-6 my-2"><i class="fas fa-clock mr-1"></i>
<span>7分钟阅读时长</span></div><div class="mr-6 my-2"><i class="fas fa-folder mr-1"></i>
<a href=/zh/categories/%E8%84%9A%E6%9C%AC%E5%BC%80%E5%8F%91/ class=hover:text-eureka>脚本开发</a></div></div><div class=content><ul><li><a href=#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>基本信息</a></li><li><a href=#%E5%A4%AA%E9%95%BF%E4%B8%8D%E7%9C%8B%E5%8F%AA%E8%A6%81%E6%AD%A3%E7%A1%AE%E6%AD%A5%E9%AA%A4>太长不看只要正确步骤</a></li><li><a href=#%E8%B5%B0%E8%BF%87%E7%9A%84%E8%B7%AF%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91>走过的路&踩过的坑</a></li></ul><h2 id=基本信息>基本信息</h2><p>平台：Win10<br>安装目的：使用Appium提供的<a href=http://appium.io/docs/en/advanced-concepts/image-elements/>Finding and Interacting with Image Elements</a>功能模块<br>各种Packages的版本：</p><ul><li>npm 6.14.8</li><li>node v14.15.0</li><li>python 3.9.0</li></ul><p>其他：Visual Studio 2019（在安装过程中被换成了VS2017）<br>之前的操作：在成功将Appium和真机连接之后，运行官方文档提供的sample code后，提示函数依赖opencv4nodejs模块，应运行<code>npm i -g opencv4nodejs</code>进行安装，一系列报错开始&mldr;</p><h2 id=太长不看只要正确步骤>太长不看只要正确步骤</h2><ol><li>卸载VS2019，在<a href="https://my.visualstudio.com/Downloads?PId=6542">MicroSoft Visual Studio Subscriptions</a>安装VS2017，选择正确的工作负载（“使用C++的桌面开发”、“Visual Studio扩展开发”）和单个组件（“适用于Windows的Git”、“用域CMake和Linux的Visual C++工具”、“用于CMake的Visual C++工具”、“适用于桌面的VC++ 2015.3 v14.00（v140）工具集”）</li><li>手动安装cmake，运行<code>pip install cmake</code></li><li>手动安装OpendCV<ul><li>运行<code>set OPENCV4NODEJS_DISABLE_AUTOBUILD=1</code></li><li>在这个命令行接着运行<code>choco install OpenCV -y -version 4.5.0</code></li><li>设置系统环境变量<ul><li><code>OPENCV_BIN_DIR</code>:<code>C:\tools\opencv\build\x64\vc15\bin</code></li><li><code>OPENCV_INCLUDE_DIR</code>:<code>C:\tools\opencv\build\include</code></li><li><code>OPENCV_LIB_DIR</code>:<code>C:\tools\opencv\build\x64\vc15\lib</code></li><li><code>Path</code>中新建: <code>%OPENCV_BIN_DIR%</code></li></ul></li><li>重启命令行</li></ul></li><li>更新<code>npm</code>和<code>node</code><ul><li>更新<code>npm</code>：<code>npm install -g npm</code></li><li>更新<code>node</code>：<code>where node</code>查看之前的版本安装地址。在<a href=https://nodejs.org/en/>node官网</a>下载最新版的<code>.msi</code>安装包，覆盖安装之前的版本。</li></ul></li><li>运行<code>npm i -g opencv4nodejs</code></li></ol><h2 id=走过的路踩过的坑>走过的路&踩过的坑</h2><p>运行Appium官方文档<a href=http://appium.io/docs/en/advanced-concepts/image-elements/>Finding and Interacting with Image Elements</a>给的sample code：</p><pre><code class=language-python>driver.update_settings({&quot;getMatchedImageResult&quot;: True})
el = driver.find_element_by_image('C:/Users/30544/Desktop/test_cross.png')
el.get_attribute('visual') 
</code></pre><p>报错：<code>selenium.common.exceptions.WebDriverException: Message: An unknown server-side error occurred while processing the command. Original error: 'opencv4nodejs' module is required to use OpenCV features. Please install it first ('npm i -g opencv4nodejs') and restart Appium.</code></p><p>其中给了一个opencv4nodejs的<a href=https://github.com/justadudewhohacks/opencv4nodejs#how-to-install>how to install</a>的链接。</p><blockquote><p><strong>Important Note!</strong><br>opencv4nodejs不能安装在含有空格的路径下。比如，安装在"C:\Program Files\some_dir"下时会报错“error C1083 &mldr;”。在Windows环境下安装时，如果没有Visual Studio，还需要Windows Build Tools来编译OpenCV和opencv4nodejs。</p></blockquote><p>运行<code>npm install --save opencv4nodejs</code>，报错：缺少cmake。
运行<code>npm install --global windows-build-tools</code>安装编译OpenCV和opencv4nodejs的Windows Build Tools。（待确认，有VS2017的话需要这一步吗）<br><strong>运行<code>pip install cmake</code>之后</strong>，重新尝试运行第一条命令<code>npm install --save opencv4nodejs</code>，报错的地方通过了，但提示新错误：</p><pre><code>CMake Error at CMakeLists.txt(project):
  Generator

    Visual Studio 15 2017 Win64

  could not find any instance of Visual Studio.
</code></pre><p>本来想的是，把它要找的那个从VS2017变成VS2019，尝试了各种对VS2019的设置、对环境变量的设置、对<code>mscv</code>的设置等等，都未解决。使用这个<a href=https://www.pianshen.com/article/22701428686/>解决方法</a>解决了Visual Studio下载速度很慢的问题。</p><p>部分未能解决的方法：</p><ul><li><a href=https://stackoverflow.com/questions/51668676/cmake-visual-studio-15-2017-could-not-find-any-instance-of-visual-studio>CMake: Visual Studio 15 2017 could not find any instance of Visual Studio</a>更改了VS160xxxx环境变量的值——未解决</li><li><a href=https://github.com/ycm-core/YouCompleteMe/issues/3472>could not find any instance of Visual Studio. (solved) #3472</a></li><li><a href=https://stackoverflow.com/questions/60068168/cmake-problem-could-not-find-any-instance-of-visual-studio>CMake problem: could not find any instance of Visual Studio</a></li><li>根据<a href=https://www.cnblogs.com/qq2806933146xiaobai/p/13359446.html>这篇博客</a>对Visual Studio进行了修改——未解决</li></ul><p><strong>解决方法：卸载VS2019， 安装VS2017</strong><br>那干脆直接把VS2019换成VS2017不就好了！它要什么给它什么！</p><ol><li><strong>下载</strong>：VS2017的下载入口太隐蔽了，在<a href="https://my.visualstudio.com/Downloads?PId=6542">MicroSoft Visual Studio Subscriptions</a>中在搜索框中搜索<code>2017</code>才会有。下载其中的<code>Visual Studio Community 2017 (version 15.9)</code>版本，选项为<code>mul</code>, <code>English</code>, <code>EXE</code>。</li><li><strong>问题：无法从"https://aka.ms/vs/15/release/channel"下载通道清单</strong>：单纯的网络问题。几种解决办法：一是到<a href=https://tool.chinaz.com/dns/>站长工具</a>里的DNS查询输入aka.ms找相对快一点的DNS并修改hosts文件，按<a href=https://www.pianshen.com/article/22701428686/>这篇博客</a>来就行；二是等一个晚上（真的&mldr;），我就是睡了一觉第二天起来试的第一遍就OK了，不敢相信，找个网好的合适时机吧。</li><li><strong>选择工作负载和组件</strong>：现在成功把含有VS2017的Visual Studio Installer下载下来了，在选择工作负载和组件的时候要特别注意确保以下被勾选。</li></ol><ul><li>工作负载：确认“使用C++的桌面开发”、“Visual Studio扩展开发”</li><li>单个组件：“适用于Windows的Git”、“用域CMake和Linux的Visual C++工具”、“用于CMake的Visual C++工具”、“适用于桌面的VC++ 2015.3 v14.00（v140）工具集”</li></ul><p>再次尝试运行<code>appium</code>和<code>python test.py</code>，原来的问题解决了，但接着出了一个新的问题。官方文档的意思是运行<code>npm i -g opencv4nodejs</code>运行了一个自动构建脚本帮你直接安装cmake、opencv的，然而在运行到这些安装时都出了问题。既然这样，何不尝试自己手动先把cmake和opencv安装得没问题了再说呢？</p><p>于是，接下来开始参考官方文档的Installing OpenCV Manually部分。</p><p>我们选择了自行设置OpenCV，因此需要设置一个环境变量以阻止自动构建脚本运行：</p><ul><li><p><strong>运行<code>set OPENCV4NODEJS_DISABLE_AUTOBUILD=1</code>——设置临时环境变量</strong><br>注意，这条命令仅在当前命令行窗口有效，因此不要关闭这个cmd窗口，接下来有关的步骤仍在这个窗口中进行。</p></li><li><p><strong>运行<code>choco install OpenCV -y -version 4.5.0</code>——安装OpenCV</strong><br>找不到<code>choco</code>命令的话安装一个就行了。4.5.0是当前的OpenCV最新版本，你可以选择自己需要的版本。</p></li><li><p><strong>设置系统环境变量</strong><br>在通过自己的OpenCV安装来安装opencv4nodejs之前，需要设置以下环境变量：</p><ul><li><code>OPENCV_BIN_DIR</code>: <code>C:\tools\opencv\build\x64\vc15\bin</code></li><li><code>OPENCV_INCLUDE_DIR</code>: <code>C:\tools\opencv\build\include</code></li><li><code>OPENCV_LIB_DIR</code>: <code>C:\tools\opencv\build\x64\vc15\lib</code></li><li><code>Path</code>中新建: <code>%OPENCV_BIN_DIR%</code></li></ul></li></ul><p>配置第一个环境变量的时候踩了个大坑，在最后才发现，感谢<a href=https://github.com/justadudewhohacks/opencv4nodejs/issues/84>Issue: #84</a>的回答者们。</p><p>最后记得<strong>重启命令行</strong>。</p><p><strong>运行<code>npm i -g opencv4nodejs</code></strong> ，这次没有报错了，然而远远还不够&mldr;</p><p>再次尝试运行<code>appium</code>和<code>python test.py</code>，运行<code>appium</code>的命令行报错<code>Failed to load global package 'opencv4nodejs': The “path” argument must be of type string. Received type undefined... Error: The specified module could not be found.</code></p><p>难道是我的<code>opencv4nodejs</code>没有安装好或者找不到吗？以下是对于这个问题我进行的操作：</p><ul><li>根据<a href=https://github.com/appium/appium/issues/11865>Issue: #11865</a>中KazuCocoa提供的回答，我尝试运行了<code>npm list opencv4nodejs</code>，在我的python虚拟环境中的确是<code>--empty</code>，这就很奇怪了</li><li>查看运行着<code>appium</code>的命令行报错，它提供了找不到的地址，但是这个地址打开有opencv4nodejs.node这个文件</li></ul><p>解决方法：<a href=https://github.com/justadudewhohacks/opencv4nodejs/issues/50>Issue: #50</a>中justadudewhohacks的回答启发了我。发现是环境变量配置错误。之前给出的环境变量已经是正确版本了。根据<a href=https://github.com/justadudewhohacks/opencv4nodejs/issues/84>Issue: #84</a>中marcelogft的回答解决，感谢！</p><p>再次尝试运行<code>appium</code>和<code>python test.py</code>，运行<code>appium</code>的命令行报错<code>The module ... was compiled against a different Node.js version using</code>.</p><p><strong>解决方法：更新<code>npm</code>和<code>node</code>至最新版本，rebuild module <code>opencv4nodejs</code></strong>
既然提示版本问题就更新版本。<br>更新<code>npm</code>和<code>node</code>的方法来自<a href=https://www.jianshu.com/p/0f3fdf6c0d5f>Windows系统下更新npm和node</a>。<br>更新<code>opencv4nodejs</code>的方法来自<a href=https://stackoverflow.com/questions/46384591/node-was-compiled-against-a-different-node-js-version-using-node-module-versio>Node - was compiled against a different Node.js version using NODE_MODULE_VERSION 51</a></p><ul><li>更新<code>npm</code>：使用<code>npm -v</code>查看当前版本，使用<code>npm install -g npm</code>或<code>npm install npm@latest -g</code>升级至最新版本</li><li>更新<code>node</code>：使用<code>where node</code>查看之前的版本安装在哪儿。在<a href=https://nodejs.org/en/>node官网</a>下载最新版的<code>.msi</code>安装包，覆盖安装之前的版本即可。这个过程比较长，会打开Windows Powershell，需要重启电脑等等，跟着上面提示的步骤来就可以了，如果运行安装包安装失败应该怎么办也都在输出中写明了。</li><li>rebuild opencv4nodejs：进入到opencv4nodejs的安装路径下，在我这里是进入到<code>~\AppData\Roaming\npm\node_modules</code>，运行<code>npm rebuild opencv4nodejs --update-binary</code>。因为之前更新了npm和node，这里的binary files也要进行更新。</li></ul><p>再次运行<code>appium</code>和<code>python test.py</code>，识别代码运行成功！！安装完成！！</p><p>希望未来的开发之路顺利！有困难我也能很好很耐心地去解决！</p></div><div class=my-4><a href=/zh/tags/appium/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#Appium</a>
<a href=/zh/tags/opencv4nodejs/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#opencv4nodejs</a>
<a href=/zh/tags/installation/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#Installation</a></div><div class=py-2><div class="flex flex-col md:flex-row items-center my-8"><a href=/zh/authors/mrq/ class="w-24 h-24 md:mr-4"><img src=/zh/authors/mrq/avatar.jpg class="w-full bg-primary-bg rounded-full" alt=Avatar></a><div class="w-full md:w-auto mt-4 md:mt-0"><a href=/zh/authors/mrq/ class="block font-bold text-lg pb-1 mb-2 border-b">Ruiqi</a>
<span class="block pb-2">有梦想，有追求，有吃的，有喝的，有玩的，有爱的</span>
<a href=mailto:happy.malechi@gmail class=mr-1><i class="fas fa-envelope"></i></a>
<a href=https://https://twitter.com/malechi20 class=mr-1><i class="fab fa-twitter"></i></a>
<a href=https://github.com/malechiMLC class=mr-1><i class="fab fa-github"></i></a></div></div></div><div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t"><div><span class="block font-bold">上一页</span>
<a href=/zh/posts/js-array/ class=block>JavaScript数组操作方法</a></div><div class="md:text-right mt-4 md:mt-0"><span class="block font-bold">下一页</span>
<a href=/zh/posts/appium-jiangnan-script-auto-well/ class=block>游戏脚本-自动生产 Android Python Appium</a></div></div><script id=utterances src=https://utteranc.es/client.js issue-term=pathname repo=ruiqima/comments theme=preferred-color-scheme crossorigin=anonymous async></script><script>((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementById('utterances').setAttribute('theme','github-dark')</script></div><div class=col-span-2><div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg"><span class="text-lg font-semibold">本页内容</span></div><div class="sticky-toc hidden lg:block px-6 pb-6"><nav id=TableOfContents><ul><li><a href=#基本信息>基本信息</a></li><li><a href=#太长不看只要正确步骤>太长不看只要正确步骤</a></li><li><a href=#走过的路踩过的坑>走过的路&踩过的坑</a></li></ul></nav></div><script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script></div><div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded p-6"><h2 class="text-lg font-semibold mb-4">相关</h2><div class=content><a href=/zh/posts/appium-jiangnan-script-auto-well/>游戏脚本-自动生产 Android Python Appium</a><br><a href=/zh/posts/appium-python/>VSCode+Python+Appium安装及简单示例</a><br></div></div></div><script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script></div></div></main><footer class=pl-scrollbar><div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2021 Ruiqi Ma &#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>